const images=["img/2.png","img/3.png","img/4 (1).png","img/5 (1).png","img/6.png","img/7.png","img/8.png","img/9.png","img/13.png","img/14.png","img/15.png"];let current=0;function showImage(t){const e=document.getElementById("carousel-image-guide");e&&(e.src=images[t])}function prevImage(){current=(current-1+images.length)%images.length,showImage(current)}function nextImage(){current=(current+1)%images.length,showImage(current)}document.addEventListener("DOMContentLoaded",function(){showImage(current);const t=document.getElementById("carousel-prev-guide"),e=document.getElementById("carousel-next-guide");t&&t.addEventListener("click",prevImage),e&&e.addEventListener("click",nextImage),showStudentShort(currentStudentShort);const n=document.getElementById("carousel-prev-student"),o=document.getElementById("carousel-next-student");n&&n.addEventListener("click",prevStudentShort),o&&o.addEventListener("click",nextStudentShort)});const studentShorts=["shorts/1","shorts/2","shorts/3"];let currentStudentShort=0;function showStudentShort(t){const e=document.getElementById("carousel-student-video");e&&(e.src=`https://www.youtube.com/embed/${studentShorts[t]}?rel=0`)}function prevStudentShort(){currentStudentShort=(currentStudentShort-1+studentShorts.length)%studentShorts.length,showStudentShort(currentStudentShort)}function nextStudentShort(){currentStudentShort=(currentStudentShort+1)%studentShorts.length,showStudentShort(currentStudentShort)}function startCountdown(){if(!document.querySelector(".countdown"))return;const t=(new Date).getTime()+324e5,e=document.getElementById("days"),n=document.getElementById("hours"),o=document.getElementById("minutes"),s=document.getElementById("seconds");if(!(e&&n&&o&&s))return;const r=()=>{const r=(new Date).getTime(),a=t-r;if(a<0)return clearInterval(c),e.innerHTML="0",n.innerHTML="0",o.innerHTML="0",void(s.innerHTML="0");const i=Math.floor(a/864e5),l=Math.floor(a%864e5/36e5),d=Math.floor(a%36e5/6e4),u=Math.floor(a%6e4/1e3);e.innerHTML=i<10?"0"+i:i,n.innerHTML=l<10?"0"+l:l,o.innerHTML=d<10?"0"+d:d,s.innerHTML=u<10?"0"+u:u},c=setInterval(r,1e3);r()}document.addEventListener("DOMContentLoaded",()=>{startCountdown();const t=document.querySelectorAll(".open-modal-button"),e=document.getElementById("modal-close-btn"),n=document.getElementById("form-modal-overlay"),o=document.getElementById("form-modal");if(o){t.forEach(t=>{t.addEventListener("click",t=>{t.preventDefault(),o.classList.add("active"),n.classList.add("active")})});const s=()=>{o.classList.remove("active"),n.classList.remove("active")};e.addEventListener("click",s),n.addEventListener("click",s)}const s=document.querySelector("#phone");s&&window.intlTelInput(s,{initialCountry:"auto",geoIpLookup:t=>{fetch("https://ipapi.co/json").then(t=>t.json()).then(e=>t(e.country_code)).catch(()=>t("us"))},utilsScript:"https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js"});const r=document.getElementById("bitrix-form");r&&r.addEventListener("submit",async t=>{t.preventDefault();const e="https://nextgeneration.bitrix24.kz/rest/55843/8z96i1qpctkkn0yz/",s=t.target,r=new FormData(s),c={};r.forEach((t,e)=>{c[e]=t});const a=s.querySelector(".submit-button"),i=document.getElementById("form-message");a.textContent="Отправка...",a.disabled=!0,i.style.display="none",i.className="",console.log("--- Bitrix24 Submission Started ---"),console.log("Deal Category ID:",31),console.log("Form Data:",c);try{console.log("Step 1: Fetching stages for the funnel...");const t=await fetch(e+"crm.dealcategory.stage.list.json",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:31})});console.log("Step 1 Response Status:",t.status);const r=await t.json();if(console.log("Step 1 Response Body (Stages):",r),!r.result||0===r.result.length)throw new Error("Could not find any stages for deal category 31. Check permissions or category ID.");const l=r.result[0].STATUS_ID;let d;console.log("Step 1 Success: Found initial stage ID:",l),console.log("Step 2: Creating or finding contact...");const u={fields:{NAME:c.NAME,PHONE:[{VALUE:c.PHONE,VALUE_TYPE:"WORK"}],OPENED:"Y"}},g=await fetch(e+"crm.contact.add.json",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u)});console.log("Step 2.1 (Add Contact) Response Status:",g.status);const m=await g.json();if(console.log("Step 2.1 (Add Contact) Response Body:",m),m.result)d=m.result;else{if("DUPLICATE_COMMUNICATION"!==m.error)throw new Error(m.error_description||"Unknown error creating contact.");{console.log("Step 2.2: Duplicate contact found. Searching for existing contact...");const t=await fetch(e+"crm.contact.list.json",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({filter:{PHONE:c.PHONE}})});console.log("Step 2.2 (Find Contact) Response Status:",t.status);const n=await t.json();if(console.log("Step 2.2 (Find Contact) Response Body:",n),!(n.result&&n.result.length>0))throw new Error("Duplicate contact exists but could not be found by phone number.");d=n.result[0].ID,console.log("Step 2.2 Success: Found existing contact ID:",d)}}console.log(`Step 3: Creating deal with Contact ID: ${d} and Stage ID: ${l}`);const S={fields:{TITLE:"Заявка с сайта",CATEGORY_ID:31,STAGE_ID:l,CONTACT_ID:d,COMMENTS:`Проект: ${c.PROJECT}\nРоль: ${c.ROLE}\nКласс: ${c.GRADE}\nРегион: ${c.REGION}`,SOURCE_ID:"WEB"}};console.log("Step 3 Deal Payload:",S);const h=await fetch(e+"crm.deal.add.json",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(S)});console.log("Step 3 (Create Deal) Response Status:",h.status);const p=await h.json();if(console.log("Step 3 (Create Deal) Response Body:",p),!p.result)throw new Error(p.error_description||"Unknown error creating deal.");console.log("--- Bitrix24 Submission Succeeded ---"),i.textContent="Успешно отправлено! Мы скоро с вами свяжемся.",i.className="success",i.style.display="block",a.textContent="Успешно!",setTimeout(()=>{o.classList.remove("active"),n.classList.remove("active"),s.reset(),a.textContent="Получить консультацию",a.disabled=!1,i.style.display="none"},3e3)}catch(t){console.error("--- Bitrix24 Submission Failed ---",t),i.textContent="Произошла ошибка. Пожалуйста, попробуйте еще раз.",i.className="error",i.style.display="block",a.textContent="Ошибка. Попробуйте снова.",a.disabled=!1}})});